#!/bin/bash -l
#SBATCH -N 1
#SBATCH -t 06:00:00
#SBATCH --partition=fat_genoa
#SBATCH --exclusive
#SBATCH --constraint=scratch-node

df -BG $TMPDIR

source ${HOME}/.bashrc
mamba activate globgm

modelRoot=$1
id=$2
solution=$3
runType=$4
dataDir=$5
outFile=$6

exe=$dataDir/_bin/mf6ggm_181121
model_input=$modelRoot/model_input/2_partition_and_write_model_input/transient
moddir=$modelRoot/mf6_mod/mf6_mod_${id}
inpmod=mf6_mod_tr.inp
inpexe=mf6ggm_tr.inp

IN_DIR=$dataDir/globgm_input
globgmDir=$modelRoot
OUT_DIR=$modelRoot/input_map/transient
forcingDir=$modelRoot/forcing_input
START_DATE=$(grep 'STARTDATE' ${moddir}/${inpmod} | awk '{print $2}')
nMonths=$(grep 'NPER' ${moddir}/${inpmod} | awk '{print $2}')
PCR_GLOB_dir=$(realpath ../model_tools_src/python/pcr-globwb)
modifyPathScript=$(realpath ../model_tools_src/python/initial_states/initial_statesModifyPath.py)
cd $PCR_GLOB_dir
wait 

cp ${moddir}/${inpmod} ${moddir}/${inpmod}_${solution}_${id}
cp ${moddir}/${inpexe} ${moddir}/${inpexe}_${solution}_${id}

inputStr=mf6_mod_tr.inp_${solution}_${id}
sed -i "s|mf6_mod_tr.inp|${inputStr}|g" ${moddir}/${inpexe}_${solution}_${id}
sed -i "s|INPUT_DIST_DIR ${modelRoot}|INPUT_DIST_DIR ${globgmDir}|g" ${moddir}/${inpmod}_${solution}_${id}
wait 

cd ${moddir}

if [ $solution -eq 1 ]; then
    startMod=1
    endMod=224
fi

if [ $solution -eq 2 ]; then
    startMod=225
    endMod=320
fi

if [ $solution -eq 3 ]; then
    startMod=321
    endMod=352
fi

if [ $solution -eq 4 ]; then
    startMod=353
    endMod=384
fi
for ((i=$startMod; i<=$endMod; i+=2)); do
    ii=$((i + 1))
    if [ $ii -gt 384 ]; then
        ii=384
    fi
    ${exe} ${inpexe}_${solution}_${id} $i $ii &
done
wait

rm ${moddir}/${inpexe}_${solution}_${id}
rm ${moddir}/${inpmod}_${solution}_${id}
wait

if [ $runType == "subRun" ]; then
    python $modifyPathScript $moddir
fi

wait
touch $outFile
df -BG $TMPDIR